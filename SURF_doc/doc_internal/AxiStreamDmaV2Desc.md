# Entity: AxiStreamDmaV2Desc

- **File**: AxiStreamDmaV2Desc.vhd
## Diagram

![Diagram](AxiStreamDmaV2Desc.svg "Diagram")
## Description

-----------------------------------------------------------------------------
 Company    : SLAC National Accelerator Laboratory
-----------------------------------------------------------------------------
 Description:
 Descriptor manager for AXI DMA read and write engines.
-----------------------------------------------------------------------------
 This file is part of 'SLAC Firmware Standard Library'.
 It is subject to the license terms in the LICENSE.txt file found in the
 top-level directory of this distribution and at:
    https://confluence.slac.stanford.edu/display/ppareg/LICENSE.html.
 No part of 'SLAC Firmware Standard Library', including this file,
 may be copied, modified, propagated, or distributed except according to
 the terms contained in the LICENSE.txt file.
-----------------------------------------------------------------------------
## Generics

| Generic name       | Type                  | Value       | Description                                                                               |
| ------------------ | --------------------- | ----------- | ----------------------------------------------------------------------------------------- |
| TPD_G              | time                  | 1 ns        |                                                                                           |
| CHAN_COUNT_G       | integer range 1 to 16 | 1           | Number of read & write DMA engines to support for each descriptor engine                  |
| AXIL_BASE_ADDR_G   | slv(31 downto 0)      | x"00000000" | Base address of descriptor registers & FIFOs                                              |
| AXI_CONFIG_G       | AxiConfigType         |             | Configuration of AXI bus, must be 64 bits (or wider)                                      |
| DESC_AWIDTH_G      | integer range 4 to 32 | 12          | Number of descriptor entries in write FIFO and return ring buffers                        |
| DESC_ARB_G         | boolean               | true        | Choose between one-clock arbitration for return descriptors or count and check selection  |
| DESC_SYNTH_MODE_G  | string                | "inferred"  | Choose between infeered or xpm generated descriptor FIFOs                                 |
| DESC_MEMORY_TYPE_G | string                | "block"     | Choose the type of resources for the descriptor FIFOs when DESC_SYNTH_MODE_G="xpm"        |
## Ports

| Port name       | Direction | Type                                             | Description                                  |
| --------------- | --------- | ------------------------------------------------ | -------------------------------------------- |
| axiClk          | in        | sl                                               | Clock/Reset                                  |
| axiRst          | in        | sl                                               |                                              |
| axilReadMaster  | in        | AxiLiteReadMasterType                            | Local AXI Lite Bus                           |
| axilReadSlave   | out       | AxiLiteReadSlaveType                             |                                              |
| axilWriteMaster | in        | AxiLiteWriteMasterType                           |                                              |
| axilWriteSlave  | out       | AxiLiteWriteSlaveType                            |                                              |
| interrupt       | out       | sl                                               | Additional signals                           |
| online          | out       | slv(CHAN_COUNT_G-1 downto 0)                     |                                              |
| acknowledge     | out       | slv(CHAN_COUNT_G-1 downto 0)                     |                                              |
| dmaWrDescReq    | in        | AxiWriteDmaDescReqArray(CHAN_COUNT_G-1 downto 0) | DMA write descriptor request, ack and return |
| dmaWrDescAck    | out       | AxiWriteDmaDescAckArray(CHAN_COUNT_G-1 downto 0) |                                              |
| dmaWrDescRet    | in        | AxiWriteDmaDescRetArray(CHAN_COUNT_G-1 downto 0) |                                              |
| dmaWrDescRetAck | out       | slv(CHAN_COUNT_G-1 downto 0)                     |                                              |
| dmaRdDescReq    | out       | AxiReadDmaDescReqArray(CHAN_COUNT_G-1 downto 0)  | DMA read descriptor request, ack and return  |
| dmaRdDescAck    | in        | slv(CHAN_COUNT_G-1 downto 0)                     |                                              |
| dmaRdDescRet    | in        | AxiReadDmaDescRetArray(CHAN_COUNT_G-1 downto 0)  |                                              |
| dmaRdDescRetAck | out       | slv(CHAN_COUNT_G-1 downto 0)                     |                                              |
| axiRdCache      | out       | slv(3 downto 0)                                  | Config                                       |
| axiWrCache      | out       | slv(3 downto 0)                                  |                                              |
| axiWriteMasters | out       | AxiWriteMasterArray(CHAN_COUNT_G-1 downto 0)     | AXI Interface                                |
| axiWriteSlaves  | in        | AxiWriteSlaveArray(CHAN_COUNT_G-1 downto 0)      |                                              |
| buffGrpPause    | out       | slv(7 downto 0)                                  | Buffer Group Pause                           |
## Signals

| Name           | Type                           | Description |
| -------------- | ------------------------------ | ----------- |
| r              | RegType                        |             |
| rin            | RegType                        |             |
| rdFifoValid    | slv(RD_FIFO_CNT_C-1 downto 0)  |             |
| rdFifoDout     | slv(RD_FIFO_BITS_C-1 downto 0) |             |
| wrFifoValid    | slv(WR_FIFO_CNT_C-1 downto 0)  |             |
| wrFifoDout     | slv(WR_FIFO_BITS_C-1 downto 0) |             |
| intSwAckEn     | sl                             |             |
| intCompValid   | sl                             |             |
| intDiffValid   | sl                             |             |
| invalidCount   | sl                             |             |
| diffCnt        | slv(31 downto 0)               |             |
| holdoffCompare | sl                             |             |
| idBuffCompare  | slv(7 downto 0)                |             |
## Constants

| Name              | Type          | Value                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Description |
| ----------------- | ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| AXI_DESC_CONFIG_C | AxiConfigType |  (       ADDR_WIDTH_C => AXI_CONFIG_G.ADDR_WIDTH_C,<br><span style="padding-left:20px">       DATA_BYTES_C => 16,<br><span style="padding-left:20px">               -- Force 128b descriptor       ID_BITS_C    => AXI_CONFIG_G.ID_BITS_C,<br><span style="padding-left:20px">       LEN_BITS_C   => AXI_CONFIG_G.LEN_BITS_C)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |             |
| CHAN_SIZE_C       | integer       |  bitSize(CHAN_COUNT_G-1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |             |
| RET_COUNT_C       | integer       |  CHAN_COUNT_G*2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |             |
| RET_SIZE_C        | integer       |  bitSize(RET_COUNT_C-1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |             |
| RD_FIFO_CNT_C     | integer       |  4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |             |
| RD_FIFO_BITS_C    | integer       |  RD_FIFO_CNT_C * 32                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |             |
| WR_FIFO_CNT_C     | integer       |  2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |             |
| WR_FIFO_BITS_C    | integer       |  WR_FIFO_CNT_C * 32                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |             |
| REG_INIT_C        | RegType       |  (       -- Write descriptor interface       dmaWrDescAck    => (others => AXI_WRITE_DMA_DESC_ACK_INIT_C),<br><span style="padding-left:20px">       dmaWrDescRetAck => (others => '0'),<br><span style="padding-left:20px">       -- Read descriptor interface       dmaRdDescReq    => (others => AXI_READ_DMA_DESC_REQ_INIT_C),<br><span style="padding-left:20px">       dmaRdDescRetAck => (others => '0'),<br><span style="padding-left:20px">       -- AXI-Lite Register Access       axilReadSlave   => AXI_LITE_READ_SLAVE_INIT_C,<br><span style="padding-left:20px">       axilWriteSlave  => AXI_LITE_WRITE_SLAVE_INIT_C,<br><span style="padding-left:20px">       -- AXI4 Descriptor       axiWriteMaster  => axiWriteMasterInit(AXI_DESC_CONFIG_C,<br><span style="padding-left:20px"> '1',<br><span style="padding-left:20px"> "01",<br><span style="padding-left:20px"> "0000"),<br><span style="padding-left:20px">       -- Configuration       wrBaseAddr      => (others => '0'),<br><span style="padding-left:20px">       rdBaseAddr      => (others => '0'),<br><span style="padding-left:20px">       maxSize         => (others => '0'),<br><span style="padding-left:20px">       contEn          => '0',<br><span style="padding-left:20px">       dropEn          => '0',<br><span style="padding-left:20px">       enable          => '0',<br><span style="padding-left:20px">       forceInt        => '0',<br><span style="padding-left:20px">       intEnable       => '0',<br><span style="padding-left:20px">       online          => (others => '0'),<br><span style="padding-left:20px">       acknowledge     => (others => '0'),<br><span style="padding-left:20px">       fifoReset       => '1',<br><span style="padding-left:20px">       intSwAckReq     => '0',<br><span style="padding-left:20px">       intAckCount     => (others => '0'),<br><span style="padding-left:20px">       descWrCache     => (others => '0'),<br><span style="padding-left:20px">       buffRdCache     => (others => '0'),<br><span style="padding-left:20px">       buffWrCache     => (others => '0'),<br><span style="padding-left:20px">       enableCnt       => (others => '0'),<br><span style="padding-left:20px">       idBuffThold     => (others => (others => '0')),<br><span style="padding-left:20px">       -- FIFOs       fifoDin         => (others => '0'),<br><span style="padding-left:20px">       wrFifoWr        => (others => '0'),<br><span style="padding-left:20px">       rdFifoWr        => (others => '0'),<br><span style="padding-left:20px">       addrFifoSel     => '0',<br><span style="padding-left:20px">       wrFifoRd        => '0',<br><span style="padding-left:20px">       wrFifoValidDly  => (others => '0'),<br><span style="padding-left:20px">       wrAddrValid     => '0',<br><span style="padding-left:20px">       rdFifoRd        => '0',<br><span style="padding-left:20px">       rdFifoValidDly  => (others => '0'),<br><span style="padding-left:20px">       rdAddrValid     => '0',<br><span style="padding-left:20px">       -- Write Desc Request       wrReqValid      => '0',<br><span style="padding-left:20px">       wrReqCnt        => 0,<br><span style="padding-left:20px">       wrReqNum        => (others => '0'),<br><span style="padding-left:20px">       wrReqAcks       => (others => '0'),<br><span style="padding-left:20px">       wrReqMissed     => (others => '0'),<br><span style="padding-left:20px">       -- Desc Return       descRetList     => (others => '0'),<br><span style="padding-left:20px">       descState       => IDLE_S,<br><span style="padding-left:20px">       descRetCnt      => 0,<br><span style="padding-left:20px">       descRetNum      => (others => '0'),<br><span style="padding-left:20px">       descRetAcks     => (others => '0'),<br><span style="padding-left:20px">       wrIndex         => (others => '0'),<br><span style="padding-left:20px">       wrMemAddr       => (others => '0'),<br><span style="padding-left:20px">       rdIndex         => (others => '0'),<br><span style="padding-left:20px">       rdMemAddr       => (others => '0'),<br><span style="padding-left:20px">       intReqEn        => '0',<br><span style="padding-left:20px">       intReqCount     => (others => '0'),<br><span style="padding-left:20px">       interrupt       => '0',<br><span style="padding-left:20px">       intHoldoff      => toSlv(10000,<br><span style="padding-left:20px"> 16),<br><span style="padding-left:20px">  -- ~20 kHz       intHoldoffCount => (others => '0'),<br><span style="padding-left:20px">       idBuffCount     => (others => (others => '0')),<br><span style="padding-left:20px">       idBuffInc       => (others => '0'),<br><span style="padding-left:20px">       idBuffDec       => (others => '0'),<br><span style="padding-left:20px">       buffGrpPause    => (others => '0')) |             |
## Types

| Name          | Type                                                                                                                                            | Description |
| ------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| DescStateType | ( IDLE_S,<br><span style="padding-left:20px"> WRITE_S,<br><span style="padding-left:20px"> READ_S,<br><span style="padding-left:20px"> WAIT_S)  |             |
| RegType       |                                                                                                                                                 |             |
## Processes
- comb: ( axiRst, axiWriteSlaves, axilReadMaster, axilWriteMaster,
                   diffCnt, dmaRdDescAck, dmaRdDescRet, dmaWrDescReq,
                   dmaWrDescRet, holdoffCompare, idBuffCompare, intSwAckEn,
                   invalidCount, r, rdFifoDout, rdFifoValid, wrFifoDout,
                   wrFifoValid )
**Description**
---------------------------------------  Control Logic --------------------------------------- 
- seq: ( axiClk )
## Instantiations

- U_invalidCount: surf.DspComparator
**Description**
---------------------------------------
 Interrupt ACK Counter
---------------------------------------
 Check for invalid count

- U_diffCnt: surf.DspAddSub
**Description**
  (a <  b) <--> r.intAckCount > r.intReqCount

- U_holdoffCompare: surf.DspComparator
