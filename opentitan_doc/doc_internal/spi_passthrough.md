# Entity: spi_passthrough

## Diagram

![Diagram](spi_passthrough.svg "Diagram")
## Description

Copyright lowRISC contributors.
 Licensed under the Apache License, Version 2.0, see LICENSE for details.
 SPDX-License-Identifier: Apache-2.0
 Serial Peripheral Interface (SPI) Device Passthrough module.
 
## Generics

| Generic name | Type         | Value | Description |
| ------------ | ------------ | ----- | ----------- |
| NumCmdInfo   | int unsigned | 16    |             |
## Ports

| Port name            | Direction | Type              | Description                                                                                                                                                                                                                                                                                                         |
| -------------------- | --------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| clk_i                | input     |                   | SPI input clk                                                                                                                                                                                                                                                                                                       |
| rst_ni               | input     |                   | SPI reset                                                                                                                                                                                                                                                                                                           |
| clk_out_i            | input     |                   | SPI output clk                                                                                                                                                                                                                                                                                                      |
| cfg_cmd_filter_i     | input     | [255:0]           | command filter information is given as 256bit register. It is subject to bechanged if command config is stored in DPSRAM. If that is supported, the command config is valid at the 6th command cycle and given only 8 bits.                                                                                         |
| cfg_addr_mask_i      | input     | [31:0]            | address manipulation                                                                                                                                                                                                                                                                                                |
| cfg_addr_value_i     | input     | [31:0]            |                                                                                                                                                                                                                                                                                                                     |
| cfg_addr_4b_en_i     | input     |                   | Address mode                                                                                                                                                                                                                                                                                                        |
| spi_mode_i           | input     | spi_mode_e        |                                                                                                                                                                                                                                                                                                                     |
| cmd_info_i           | input     | [NumCmdInfo-1:0]  | Command Info structure                                                                                                                                                                                                                                                                                              |
| host_sck_i           | input     |                   | Though it would be best if passthrough is able to re-use existing spi_s2pand cmdparse, but passthrough has to implement its own s2p and cmdparse to support the A/B binary scheme.                                                                                                                                  |
| host_csb_i           | input     |                   |                                                                                                                                                                                                                                                                                                                     |
| host_s_i             | input     | [3:0]             |                                                                                                                                                                                                                                                                                                                     |
| host_s_o             | output    | [3:0]             | clk_out_i domain                                                                                                                                                                                                                                                                                                    |
| host_s_en_o          | output    | [3:0]             | clk_out_i domain                                                                                                                                                                                                                                                                                                    |
| passthrough_o        | output    | passthrough_req_t | SPI to SPI_HOST and terminal to the downstream device                                                                                                                                                                                                                                                               |
| passthrough_i        | input     | passthrough_rsp_t |                                                                                                                                                                                                                                                                                                                     |
| mailbox_hit_i        | input     |                   | If a read command falls into the mailbox address and the mailbox feature isenabled, the `Read Command` process module sends a signal to passthrough to take the control of the SPI line. If this signal asserts during Address phase, passthrough drops CSb to SPI Flash device and waits host's CSb de-assertion.  |
| event_cmd_filtered_o | output    |                   | event`cmd_filtered`: indicator of the incoming command filtered out                                                                                                                                                                                                                                                 |
## Signals

| Name                   | Type                    | Description                                                                                                                                                                                                                                                                                                                                                                   |
| ---------------------- | ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| st                     | passthrough_st_e        |                                                                                                                                                                                                                                                                                                                                                                               |
| st_d                   | passthrough_st_e        |                                                                                                                                                                                                                                                                                                                                                                               |
| host_s_en_inclk        | logic [3:0]             | internal clock                                                                                                                                                                                                                                                                                                                                                                |
| device_s_en_inclk      | logic [3:0]             |                                                                                                                                                                                                                                                                                                                                                                               |
| is_active              | logic                   | Indicate Passthrough mode is enabled or not.                                                                                                                                                                                                                                                                                                                                  |
| opcode                 | logic [7:0]             |                                                                                                                                                                                                                                                                                                                                                                               |
| opcode_d               | logic [7:0]             |                                                                                                                                                                                                                                                                                                                                                                               |
| unused_opcode_7        | logic                   |                                                                                                                                                                                                                                                                                                                                                                               |
| filter                 | logic                   | If the filter becomes 1 on the 8th beat, it lowers SCK enable signal to CG cell then, at the 8th posedge of SCK, csb_deassert becomes 1. ____      ____      ____ SCK             ____/ 7  \____/ 8  \____/ ___ filter       _______/XXXXXX/   \______________ ______________ sck_gate_en                \__________________ ______________ csb_deassert __________________/  |
| sck_gate_en            | logic                   | If 1, SCK propagates to the downstream SPI Flash device.                                                                                                                                                                                                                                                                                                                      |
| csb_deassert           | logic                   | However, the CSb output to the downstream flash device is better to be in the out clock domain. It helps the design constraints to be simpler. So, the `csb_deassert` is again latched at the outclk (which is the negedge of SCK).                                                                                                                                           |
| csb_deassert_outclk    | logic                   |                                                                                                                                                                                                                                                                                                                                                                               |
| bitcnt                 | logic [MetaBitCntW-1:0] |                                                                                                                                                                                                                                                                                                                                                                               |
| addrcnt                | logic [AddrCntW-1:0]    | Address or anything host driving after opcode counter                                                                                                                                                                                                                                                                                                                         |
| addrcnt_outclk         | logic [AddrCntW-1:0]    | Address or anything host driving after opcode counter                                                                                                                                                                                                                                                                                                                         |
| dummycnt               | logic [DummyCntW-1:0]   | Dummy counter                                                                                                                                                                                                                                                                                                                                                                 |
| dummycnt_d             | logic [DummyCntW-1:0]   | Dummy counter                                                                                                                                                                                                                                                                                                                                                                 |
| mailbox_hit            | logic                   | Mailbox hit.                                                                                                                                                                                                                                                                                                                                                                  |
| cmd_7th                | logic                   | 7th beat of transaction                                                                                                                                                                                                                                                                                                                                                       |
| cmd_8th                | logic                   | in 8th beat of transaction                                                                                                                                                                                                                                                                                                                                                    |
| cmd_filter             | logic [1:0]             |                                                                                                                                                                                                                                                                                                                                                                               |
| cmd_info               | cmd_info_t              |                                                                                                                                                                                                                                                                                                                                                                               |
| cmd_info_d             | cmd_info_t              |                                                                                                                                                                                                                                                                                                                                                                               |
| cmd_info_7th           | cmd_info_t [1:0]        |                                                                                                                                                                                                                                                                                                                                                                               |
| cmd_info_7th_d         | cmd_info_t [1:0]        |                                                                                                                                                                                                                                                                                                                                                                               |
| addr_size_d            | logic [AddrCntW-1:0]    |                                                                                                                                                                                                                                                                                                                                                                               |
| cmd_info_latch         | logic                   |                                                                                                                                                                                                                                                                                                                                                                               |
| unused_cmd_info_fields | logic                   | Some of the fields of cmd_info are used in the big FSM below. The opcode field and the addr_* fields are ignored because we pick them from cmd_info_d instead (in a different FSM state). We rely on the synthesis tool not to generate the unneeded flops but must explicitly waive lint warnings about unused fields.                                                       |
| addr_set               | logic                   | Address swap                                                                                                                                                                                                                                                                                                                                                                  |
| addr_phase             | logic                   |                                                                                                                                                                                                                                                                                                                                                                               |
| addr_phase_outclk      | logic                   |                                                                                                                                                                                                                                                                                                                                                                               |
| addr_swap              | logic                   | Based on AddrCnt, the logic swap. TODO: Handle the DualIO, QuadIO cases                                                                                                                                                                                                                                                                                                       |
| dummy_set              | logic                   | Dummy Counter                                                                                                                                                                                                                                                                                                                                                                 |
| passthrough_s_en       | logic [3:0]             |                                                                                                                                                                                                                                                                                                                                                                               |
| st_d                   | StFilter                |                                                                                                                                                                                                                                                                                                                                                                               |
| StWait                 | end                     |                                                                                                                                                                                                                                                                                                                                                                               |
| StDriving              | end                     |                                                                                                                                                                                                                                                                                                                                                                               |
| host_s_en_inclk        | end                     |                                                                                                                                                                                                                                                                                                                                                                               |
| StAddress              | end                     |                                                                                                                                                                                                                                                                                                                                                                               |
| st_d                   | end                     |                                                                                                                                                                                                                                                                                                                                                                               |
| endcase                | end                     |                                                                                                                                                                                                                                                                                                                                                                               |
## Constants

| Name        | Type         | Value               | Description        |
| ----------- | ------------ | ------------------- | ------------------ |
| MetaMaxBeat | int unsigned | 8+32+8              | Cmd + Addr + Dummy |
| MetaBitCntW | int unsigned | $clog2(MetaMaxBeat) |                    |
## Types

| Name             | Type                                                                                                                                                                                                                                                                                 | Description |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------- |
| passthrough_st_e | enum logic [2:0] {               StIdle,                     StFilter,                          StWait,           //                         //                    //                    StDriving,     StHighZ,           //                         //               StAddress   } | State       |
## Processes
- unnamed: ( @(posedge clk_i or negedge rst_ni) )
- unnamed: ( @(posedge clk_i or negedge rst_ni) )
- unnamed: ( @(posedge clk_i or negedge rst_ni) )
**Description**
Command Filter: CSb control

- unnamed: ( @(posedge clk_out_i or negedge rst_ni) )
- unnamed: ( @(posedge clk_i or negedge rst_ni) )
- unnamed: ( @(posedge clk_i or negedge rst_ni) )
- unnamed: (  )
**Description**
Search opcode @ 7th opcode

- unnamed: ( @(posedge clk_i or negedge rst_ni) )
- unnamed: ( @(posedge clk_i or negedge rst_ni) )
- unnamed: (  )
- unnamed: ( @(posedge clk_i or negedge rst_ni) )
- unnamed: ( @(posedge clk_out_i or negedge rst_ni) )
- unnamed: ( @(posedge clk_out_i or negedge rst_ni) )
**Description**
Address swap should happen in outclk domain.
The state machine operates in inclk domain.
The state generates mux selection signal.
The signal latched in outclk domain then activates the mux.

- unnamed: ( @(posedge clk_i or negedge rst_ni) )
- unnamed: ( @(posedge clk_out_i or negedge rst_ni) )
- unnamed: ( @(posedge clk_out_i or negedge rst_ni) )
- unnamed: ( @(posedge clk_i or negedge rst_ni) )
- unnamed: (  )
